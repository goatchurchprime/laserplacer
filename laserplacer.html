<!DOCTYPE html>
<html>
<head>
<script src="jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="raphael.js"></script>    
<script type="text/javascript" src="raphpolygonsorting.js"></script>    
<script type="text/javascript" src="raphimporting.js"></script>    
<script type="text/javascript" src="svgizingtext.js"></script>    
<script type="text/javascript" src="exportfunctions.js"></script>    
<meta charset="utf-8">
<title>Experimental SVG lattice hinge generator V4</title>
<script>


function rescalefile(fscale)
{
    var svgprocess = SVGprocesses[fadividlast]; 
    var rlistb = svgprocess.rlistb; 
    for (var i = 0; i < rlistb.length; i++) {
        rlistb[i].path.attr("path", Raphael.mapPath(rlistb[i].path.attr("path"), Raphael.matrix(fscale, 0, 0, fscale, 0, 0))); 
        //rlistb[i].path.scale(fscale, fscale, 0, 0); 
    }
    svgprocess.Lgrouppaths[0][0].attr("path", Raphael.mapPath(svgprocess.Lgrouppaths[0][0].attr("path"), Raphael.matrix(fscale, 0, 0, fscale, 0, 0))); 
}


function TestCollision(dx, dy) 
{
    for (var i = 0; i < opts.length; i++) {
        var x = opts[i][0] + dx; 
        var y = opts[i][1] + dy; 
        if (y >= paper1.height*paper1scale)
            return false; 
        for (var j = 0; j < rlist.length; j++) {
            if (rlist[j] == pathselected)
                continue; 
            if (rlist[j].isPointInside(x, y))
                return false; 
        }
    }
    return true; 
}

var paper1 = null; 
var paper1scale = 1; 
var paper1x0 = 0; 
var paper1y0 = 0; 
var filenamelist = { }; 
var rlist = [ ]; 
var SVGprocesses = { }; // indexed by fadivid (type SVGfileprocess, which it gets confused with)
var Dsvgprocess = undefined; // lastone
var fadividlast = null; 
var pathselected = null; 
var opts; 
var collidestepout = 10, collidestepover = 10; 
var ylo, yhi; 
var perprods; 
var Lgrouppath = []; 


function scalestrokewidth(fss)
{
	for (var fadivid in SVGprocesses) {
		if (SVGprocesses.hasOwnProperty(fadivid)) {
			if (SVGprocesses[fadivid].Lgrouppaths !== undefined)
				SVGprocesses[fadivid].scalestrokewidth(fss); 
		}
	}
}

function CollideBinary() 
{
    // paper1.getElementsByPoint(x, y); 
    var ymid = (ylo + yhi)/2; 
    if (TestCollision(0, ymid)) {
        ylo = ymid; 

        var basematrix = pathselected.matrix.toTransformString(); 
        var tstr = "t0,"+ylo+basematrix; 
        for (var k = 0; k < Lgrouppath.length; k++) {
            Lgrouppath[k].transform(tstr); 
        }; 

    } else {
        yhi = ymid; 
    }
    if (yhi - ylo <= collidestepout + 1) {
        perprods.remove(); 
    } else {
        setTimeout(CollideBinary, 5); 
    }
}

/* refer to: 
    elproto.isPointInside = function (x, y) {
        var rp = this.realPath = getPath[this.type](this);
        if (this.attr('transform') && this.attr('transform').length) {
            rp = R.transformPath(rp, this.attr('transform'));
        }
        return R.isPointInsidePath(rp, x, y);
    };
*/

function MoveCollide()
{
    path = pathselected; 
    var dtrans = Raphael.mapPath(path.attr("path"), path.matrix); 
    var pl = Raphael.getTotalLength(dtrans); 
    console.log(pl); 
    var ds = [ ]; 
    opts = [ ]; 
    for (var i = 0; i < pl; i += collidestepover) {
        var pal = Raphael.getPointAtLength(dtrans, i); 
        var angnorm = Raphael.rad(pal.alpha+90); 
        var sa = Math.sin(angnorm); 
        var ca = Math.cos(angnorm); 
        var d = collidestepout; 
        if (Raphael.isPointInsidePath(dtrans, pal.x+ca*d, pal.y+sa*d)) { d = -d }; 
        ds.push("M", pal.x, ",", pal.y, "l", ca*d, ",", sa*d); 
        opts.push([pal.x+ca*d, pal.y+sa*d]); 
    }
    
    perprods = paper1.path(ds.join("")); 
    ylo = 0; 
    yhi = 400; 
    
    Lgrouppath = null; 
    var Lgrouppaths = SVGprocesses[fadividlast].Lgrouppaths; 
    for (var k = 0; k < Lgrouppaths.length; k++) {
        if (Lgrouppaths[k][0] == pathselected)
            Lgrouppath = Lgrouppaths[k]; 
    }
    setTimeout(CollideBinary, 5); 
}

Dtranslats = null; 
Dxjson = null; 
function Nest1() 
{
    var polymap = { }; 
    var board = [ ]; 
    var sequence = [ ]; 
    var Ipolymap = { }; 
    //for (var i = 0; i < SVGprocesses.length; i++) {
    Object.keys(a).forEach(function(key, i) {  // untested after the above change from list to object
        var svgp = SVGprocesses[key]; 
        for (var j = 0; j < svgp.Lgrouppaths.length; j++) {
            var pth = svgp.Lgrouppaths[j][0].attr("path"); 
            var pgid = svgp.pathgroupings[j][0]; 
            polymap[pgid] = pth; 
            Ipolymap[pgid] = [key, j]; 
            
            if ((i == 0) && (j == 0)) {
                board.push(pgid); 
            } else {
                sequence.push(pgid); 
            }
        }
    }); 
}

function setraphsize() {
    var divpaper1 = document.getElementById("paper1"); 
    var divwholewindow = document.getElementById("wholewindow"); 
    var divpanelheader = document.getElementById("panelheader"); 
    paper1.setSize(divpaper1.offsetWidth, 
				   divwholewindow.offsetHeight - divpanelheader.offsetHeight - 7); 
}


var Deee; 

var Rmmscalebar = null; 
var dropsvgherenote = null;
function setup()
{
	window.addEventListener("resize", setraphsize);
	
	document.getElementById("thinnerstrokes").onclick = function() { scalestrokewidth(0.5); }; 
	document.getElementById("thickerstrokes").onclick = function() { scalestrokewidth(2); }; 
	document.getElementById("togglebackgroundcolour").onclick = function() { 
		var c = document.getElementById("paper1").style.background; 
		document.getElementById("paper1").style.background = document.getElementById("togglebackgroundcolour").style.background; 
		document.getElementById("togglebackgroundcolour").style.background = c; 
	}

    $("#exportSVG").click(exportSVG); 
    $("#exportPLT").click(exportPLT); 
    $("#movecollide").click(MoveCollide); 
    $("#nest1").click(Nest1); 
    $("#files").change(function(e) { importSVGfiles(e.target.files); });  
    $("#mmpixwidth").change(function() { 
        if (Rmmscalebar != null) {
            Rmmscalebar.remove(); 
            Rmmscalebar = null; 
        }
        var mmpixwidth = parseFloat($("#mmpixwidth").val()); 
        var woodwidth = 100; 
        var woodheight = 100; 
        Rmmscalebar = paper1.path("M10,10h"+(woodwidth*mmpixwidth)+"v5 M10,10v"+(woodheight*mmpixwidth)+"h5").attr("stroke", "#888"); 
    }); 
    
    $("#svgizetext").click(function() { 
		importSVGfiles([{type:'svgizedtext', svgtext:svgizetext($("#texttosvgize").val())}]); 
    }); 
    

	var currbackground = ""; 
    $("#paper1").on('dragover', function(e) {
        e.stopPropagation(); e.preventDefault(); 
    }).on('dragenter', function(e) {
        e.stopPropagation(); e.preventDefault(); 
        currbackground = document.getElementById("paper1").style.background; 
		document.getElementById("paper1").style.background = "#ffa"; 
    }).on('dragleave', function(e) {
        e.stopPropagation(); e.preventDefault(); 
        document.getElementById("paper1").style.background = currbackground;
		currbackground = "";  
    }).on('drop', function(e) {
        e.stopPropagation(); e.preventDefault(); 
        document.getElementById("paper1").style.background = currbackground;
		currbackground = "";  
        importSVGfiles(e.originalEvent.dataTransfer.files); 
    }); 

    $("#scaledouble").click(function() { $("#scaledouble").text($("#scaledouble").text() == "*2" ? "/2" : "*2"); }); 
    $("#scale").click(function() { 
        paper1scale *= ($("#scaledouble").text() == "*2" ? 2 : 0.5); 
        paper1.setViewBox(paper1x0*paper1scale, paper1y0*paper1scale, paper1.width*paper1scale, paper1.height*paper1scale); 
        $("#scale").text(paper1scale); 
    }); 
    $("#scaledouble, #scale").mousedown(function(e) { e.preventDefault(); }); // stop selection on double-click
    $("#scale").text(paper1scale); 
    
    // setup the raphael paper and bits
    paper1 = Raphael("paper1", 1300, 800);
    setraphsize(); 
    paper1.setViewBox(paper1x0*paper1scale, paper1y0*paper1scale, paper1.width*paper1scale, paper1.height*paper1scale); 
    
    //paper1.raphael.mousedown(function(e) { console.log(e); }); 
    $(paper1.canvas).bind('mousewheel DOMMouseScroll', function(e) {
		//console.log(e); 

		var ex, ey, ed; 
		if (e.handleObj && (e.handleObj.type == "DOMMouseScroll"))  {// firefox issue
			//console.log(e.originalEvent); 
			ex = e.originalEvent.clientX; 
			ey = e.originalEvent.clientY; 
			ed = (e.originalEvent.detail > 0); 
		} else {
			ex = e.clientX; 
			ey = e.clientY; 
			ed = (e.originalEvent.deltaY > 0); 
		}
        var paperelement = document.getElementById("paper1");
        var mx = ex - paperelement.offsetLeft - 2; 
        var my = ey - paperelement.offsetTop - 2; 
        //console.log(e.originalEvent.deltaY, mx, my, event); 
        var cx = (mx + paper1x0)*paper1scale; 
        var cy = (my + paper1y0)*paper1scale; 
        //paper1.rect(cx, cy, 5, 5); 
        paper1scale = (ed ? paper1scale*1.5 : paper1scale/1.5); 
        paper1x0 = cx/paper1scale - mx; 
        paper1y0 = cy/paper1scale - my; 
        paper1.setViewBox(paper1x0*paper1scale, paper1y0*paper1scale, paper1.width*paper1scale, paper1.height*paper1scale); 
        e.stopPropagation(); e.preventDefault(); 
        return false; 
    });

    dropsvgherenote = paper1.text(200, 60, "Drop SVG here").attr({fill: "orange"}).transform("s3").attr("fill-opacity", 0.3); 
    var data = $("#paper1 svg").attr("id", "svg1"); 
        
    $('#rescalefile').keydown(function(e) {
        if (e.keyCode == 13) {
            e.preventDefault();
            rescalefile(parseFloat($("#rescalefile").val())); 
        }
    });
    setraphsize(); 
}


//$(document).ready(setup);   // function to call only *after* page has finished loading
Raphael(setup); 

</script>

<style>
div#wholewindow { position: fixed; left: 0; top: 0; right:0; bottom: 0; overflow:auto; }
div#filearea { z-index: 10; position: fixed; bottom:10px; right:10px; background:white; border: thin blue solid }
div#paper1 { position: fixed; left: 0; right: 0; }

#err { color:red }
#scale:hover, #scaledouble:hover { background:yellow; cursor:pointer }

div#filearea  { cursor:pointer; }
div#filearea .fprocessstatus:hover { background: red; cursor: pointer }
div#filearea .spnumcols span { border: thin black solid }
div#filearea  span.delbutton { color: red }
div#filearea  span.delbutton:hover { background: red; color: black }
div#filearea .spnumcols span.selected { color: white }
div#filearea .spnumcols span:hover { border-color:white }

div#filearea .groupprocess { background:#ffc }
div#filearea .groupprocess:hover { background:#ccf }
div#filearea .groupprocess.selected { background:#ee0 }

#thinnerstrokes, #thickerstrokes, #togglebackgroundcolour { border: 0; padding: 0; color: blue }

input#mmpixwidth { width:3em }
#texttosvgize { height: 1em }

</style>

</head>
<body>

<div id="wholewindow">
  <div id="filearea">
    FileArea
  </div>
  
  <div id="panelheader">
    <input type="button" value="exportSVG" id="exportSVG"/>
    <input type="button" value="exportPLT" id="exportPLT"/>
    <input type="button" value="MOVE!" id="movecollide">
    <input type="button" value="Nest1" id="nest1">
    <span id="scale">1</span><span id="scaledouble">*2</span>
    <input type="file" id="files" name="files[]" multiple />
    <span id="pixscale">pix-scale(mm):<input type="text" id="mmpixwidth" name="mmpixwidth" value=""/></span>
    <span id="readingcancel">0/0</span>
    <span id="rescalefilesp">rescale:<input type="text" id="rescalefile" name="rescalefile" value="1.0"/></span>
    <input type="button" value="<<" id="thinnerstrokes" title="Thinner strokes">
    <input type="button" value=">>" id="thickerstrokes" title="Thicker strokes">
    <input type="button" value=".*." id="togglebackgroundcolour" title="Toggle background colour" style="background: #444" >
    
    <textarea id="texttosvgize">svgizing letters here</textarea>
    <input type="button" value="svgizetext" id="svgizetext">
  </div>
  
  <div style="border: thin black solid; background: #e8e8e8" id="paper1">
  </div>
</div>
  
</body>
</html>
